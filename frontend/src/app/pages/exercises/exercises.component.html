<div class="exercises-page-container">
  <app-navbar></app-navbar>
  <div class="exercises-page-content container-fluid px-3 px-md-4 px-lg-5">
    <header class="exercises-header">
      <h1>Welcome to Our Exercises</h1>
      <p>
        Put your skills to the test with hands-on coding challenges.<br>
        Filter by language and difficulty to find the perfect exercise.
      </p>
    </header>
    <div class="exercise-container">
      <div class="top-bar d-flex flex-wrap align-items-center gap-2 p-2 p-md-3">
        <div class="controls d-flex flex-wrap align-items-center gap-2 w-100">
          <label for="language" class="d-none d-md-inline">Language:</label>
          <div class="dropdown-wrapper position-relative">
            <button class="filter-btn language-button btn btn-dark" (click)="toggleLanguageMenu($event)">
              {{ selectedLanguage }} ▾
            </button>

            <div class="dropdown language-menu" *ngIf="showLanguageMenu">
              <button *ngFor="let lang of languages" (click)="selectLanguage(lang)">
                {{ lang }}
              </button>
            </div>
          </div>

          <div class="filter-group d-flex align-items-center gap-2 flex-wrap position-relative">
            <button (click)="toggleFilterMenu($event)" class="filter-btn filter-button btn btn-dark">
              {{ selectedFilterName }} ▾
            </button>
            <div class="dropdown filter-menu" *ngIf="showFilterMenu">
              <button (click)="applySort('title')">Alphabetic</button>
              <button (click)="applySort('difficulty')">Difficulty</button>
              <button (click)="applySort('points')">Points</button>
            </div>

            <button (click)="toggleOrder()" class="order-btn btn btn-dark">
              {{ sortOrder === 'asc' ? 'Asc ↑' : 'Desc ↓' }}
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="exercises.length > 0; else noExercises" class="exercise-list">
        <div class="exercise-card row g-0 align-items-center p-3 mb-3" *ngFor="let ex of exercises">
          <div class="exercise-content col-12 col-md-9 col-lg-10">
            <div class="exercise-header d-flex flex-wrap align-items-baseline gap-2 mb-1">
              <span class="difficulty" [style.color]="getXpColor(ex.difficulty)">
                ({{ ex.difficulty }})
              </span>
              <span class="title">{{ ex.title }}</span>
            </div>
            <div class="points" *ngIf="ex.points > 0">(Max points: {{ ex.points }})</div>
            <div class="description">
              <p class="mb-0">{{ ex.description }}</p>
            </div>
          </div>

          <div class="col-12 col-md-3 col-lg-2 mt-3 mt-md-0 d-flex justify-content-md-end">
            <button class="solve-btn btn w-100 w-md-auto" [routerLink]="['/solve', ex.id]">
              SOLVE
            </button>
          </div>
        </div>
      </div>
      <ng-template #noExercises>
        <div class="no-results">No exercises found for {{ selectedLanguage }}.</div>
      </ng-template>
    </div>
  </div>

  <button *ngIf="isUserAdmin" class="admin-add-btn" (click)="toggleAdminPopup()"> + </button>

  <div class="admin-popup-overlay" *ngIf="showAdminPopup" (click)="closeAdminPopup()">
    <div class="admin-popup-content" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>Create New Exercise</h3>
        <button class="close-popup" (click)="closeAdminPopup()">&times;</button>
      </div>

      <div class="popup-body">
        <form (ngSubmit)="saveExercise()">
          <div class="row g-2 mb-3">
            <div class="col-8">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" [(ngModel)]="newExerciseData.exercise.title" name="title" required>
            </div>
            <div class="col-4">
              <label class="form-label">Language</label>
              <input type="text" class="form-control text-center" [value]="selectedLanguage" disabled readonly>
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label">Difficulty</label>
              <select class="form-select" [(ngModel)]="newExerciseData.exercise.difficulty" name="diff">
                <option value="Easy">Easy</option>
                <option value="Medium">Medium</option>
                <option value="Hard">Hard</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Points</label>
              <input type="number" class="form-control" [(ngModel)]="newExerciseData.exercise.points" name="points">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Description / Prompt</label>
            <textarea class="form-control" rows="4" [(ngModel)]="newExerciseData.exercise.description" name="desc"></textarea>
          </div>

          <hr class="popup-divider">

          <h5 class="mb-2">Test Cases (Input &rarr; Output)</h5>
          <div class="test-cases-list mb-2">
            <div class="d-flex gap-2 mb-2 align-items-center" *ngFor="let test of newExerciseData.testCases; let i = index">
              <input type="text" class="form-control form-control-sm" [(ngModel)]="test.input" [name]="'in'+i">
              <span class="arrow">&rarr;</span>
              <input type="text" class="form-control form-control-sm" [(ngModel)]="test.expected_output" [name]="'out'+i">
              <button type="button" class="btn btn-sm btn-remove-test" (click)="removeTestCase(i)" *ngIf="newExerciseData.testCases.length > 1">&times;</button>
            </div>
          </div>

          <button type="button" class="btn btn-sm btn-add-test w-100 mb-4" (click)="addTestCase()">+ Add Test Case</button>
          <div *ngIf="errorMessage" class="error-banner mb-3">
            {{ errorMessage }}
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-save">Save Exercise</button>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>
